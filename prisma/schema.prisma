// Prisma Schema for Habita
// Household Task Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// ============================================
// CORE MODELS
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Auth relations
  accounts Account[]
  sessions Session[]

  // App relations
  members Member[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Household {
  id         String   @id @default(cuid())
  name       String
  inviteCode String   @unique @default(cuid())
  latitude   Float?
  longitude  Float?
  timezone   String?  // IANA timezone, e.g. "America/Buenos_Aires"
  country    String?  // ISO country code, e.g. "AR"
  city        String?
  planningDay Int?     // 0=Sunday..6=Saturday, null=manual planning only
  createdAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  members      Member[]
  tasks        Task[]
  assignments  Assignment[]
  rotations    TaskRotation[]
  weeklyPlans          WeeklyPlan[]
  relaxSuggestions     RelaxSuggestion[]
  dealCache            DealCache[]
  planFeedbacks        PlanFeedback[]
  expenses             Expense[]
  productExclusions    HouseholdProductExclusion[]
  priceCache           PriceCache[]
  services             Service[]
  invoices             Invoice[]
  @@map("households")
}

model Member {
  id          String     @id @default(cuid())
  userId      String
  householdId String
  name        String
  memberType  MemberType @default(ADULT)
  avatarUrl   String?
  occupationLevel OccupationLevel @default(MODERATE)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  assignments Assignment[]
  preferences  MemberPreference[]
  absences     MemberAbsence[]
  absencesAssignTo MemberAbsence[] @relation("AbsenceAssignTo")
  transfersFrom TaskTransfer[] @relation("TransferFrom")
  transfersTo   TaskTransfer[] @relation("TransferTo")
  notifications    Notification[]
  pushSubscriptions PushSubscription[]
  whatsappLink     WhatsAppLink?
  planFeedbacks    PlanFeedback[]
  expensesPaid     Expense[]      @relation("ExpensesPaid")
  expenseSplits    ExpenseSplit[] @relation("ExpenseSplits")
  servicesPaid         Service[] @relation("ServicesPaid")
  @@unique([userId, householdId])
  @@index([householdId])
  @@index([userId])
  @@map("members")
}

enum MemberType {
  ADULT
  TEEN
  CHILD
}

enum OccupationLevel {
  BUSY        // Muy ocupado/a - trabajo tiempo completo
  MODERATE    // Ocupado/a - medio tiempo o actividades
  AVAILABLE   // Disponible - más tiempo en casa
}

model Task {
  id           String        @id @default(cuid())
  householdId  String
  name         String
  description  String?
  frequency    TaskFrequency @default(WEEKLY)
  weight       Int           @default(1) // 1-5 difficulty/importance
  minAge       Int?          // Minimum age to be assigned
  estimatedMinutes Int?
  isActive           Boolean       @default(true)
  isRouletteEligible Boolean       @default(false)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  household   Household    @relation(fields: [householdId], references: [id], onDelete: Cascade)
  assignments Assignment[]
  preferences MemberPreference[]
  rotation    TaskRotation?

  @@index([householdId])
  @@index([householdId, isActive])
  @@map("tasks")
}

enum TaskFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  ONCE
}

model Assignment {
  id          String           @id @default(cuid())
  taskId      String
  memberId    String
  householdId String
  dueDate     DateTime
  status      AssignmentStatus @default(PENDING)
  completedAt DateTime?
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Relations
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  member    Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  transfers TaskTransfer[]

  @@index([householdId, dueDate])
  @@index([memberId, status])
  @@index([taskId, status])
  @@index([householdId, status, completedAt])
  @@index([memberId, status, completedAt])
  @@index([memberId, dueDate, status])
  @@map("assignments")
}

enum AssignmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  VERIFIED
  OVERDUE
  CANCELLED
}

// ============================================
// COLLABORATION MODELS
// ============================================

model MemberPreference {
  id        String         @id @default(cuid())
  memberId  String
  taskId    String
  preference PreferenceType
  createdAt DateTime       @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([memberId, taskId])
  @@map("member_preferences")
}

enum PreferenceType {
  PREFERRED
  NEUTRAL
  DISLIKED
}

model MemberAbsence {
  id               String         @id @default(cuid())
  memberId         String
  startDate        DateTime
  endDate          DateTime
  reason           String?
  policy           AbsencePolicy  @default(AUTO)
  assignToMemberId String?
  createdAt        DateTime       @default(now())

  member     Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  assignTo   Member? @relation("AbsenceAssignTo", fields: [assignToMemberId], references: [id], onDelete: SetNull)

  @@index([memberId, startDate, endDate])
  @@map("member_absences")
}

enum AbsencePolicy {
  AUTO     // Reasignar a otro miembro (algoritmo o azar)
  SPECIFIC // Reasignar a assignToMemberId
  POSTPONE // Posponer vencimiento al día siguiente al fin de la ausencia
}

model TaskTransfer {
  id           String         @id @default(cuid())
  assignmentId String
  fromMemberId String
  toMemberId   String
  reason       String?
  status       TransferStatus @default(PENDING)
  requestedAt  DateTime       @default(now())
  respondedAt  DateTime?

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  fromMember Member     @relation("TransferFrom", fields: [fromMemberId], references: [id], onDelete: Cascade)
  toMember   Member     @relation("TransferTo", fields: [toMemberId], references: [id], onDelete: Cascade)

  @@index([fromMemberId])
  @@index([toMemberId])
  @@map("task_transfers")
}

enum TransferStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// ============================================
// SCHEDULING MODELS
// ============================================

model TaskRotation {
  id          String        @id @default(cuid())
  taskId      String        @unique
  householdId String
  frequency   TaskFrequency
  isActive    Boolean       @default(true)
  lastGenerated DateTime?
  nextDueDate DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId, isActive])
  @@map("task_rotations")
}

// ============================================
// AI PLAN MODEL
// ============================================

model WeeklyPlan {
  id            String           @id @default(cuid())
  householdId   String
  status        WeeklyPlanStatus @default(PENDING)
  balanceScore  Int              @default(0)
  notes         String[]         @default([])
  assignments   Json             // Array of { taskName, memberId, memberName, memberType, reason, dayOfWeek? }
  durationDays  Int              @default(7)
  startDate     DateTime?        // Explicit plan start date (null for legacy plans)
  excludedTasks Json?            // Array of { taskName, frequency } - tasks outside plan period
  createdAt     DateTime         @default(now())
  appliedAt     DateTime?
  expiresAt     DateTime

  household Household        @relation(fields: [householdId], references: [id], onDelete: Cascade)
  feedbacks PlanFeedback[]

  @@index([householdId, status])
  @@index([householdId, status, expiresAt])
  @@map("weekly_plans")
}

enum WeeklyPlanStatus {
  PENDING   // Generated but not yet applied
  APPLIED   // User accepted and assignments created
  COMPLETED // Plan finalized (all tasks done or manually closed)
  EXPIRED   // Plan expired without being applied
  REJECTED  // User explicitly rejected
}

model PlanFeedback {
  id          String   @id @default(cuid())
  planId      String
  memberId    String
  householdId String
  rating      Int      // 1-5
  comment     String?
  createdAt   DateTime @default(now())

  plan      WeeklyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  member    Member     @relation(fields: [memberId], references: [id], onDelete: Cascade)
  household Household  @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([planId, memberId])
  @@index([householdId])
  @@map("plan_feedbacks")
}

// ============================================
// NOTIFICATION MODEL
// ============================================

model Notification {
  id        String           @id @default(cuid())
  memberId  String
  type      NotificationType
  title     String
  message   String
  actionUrl String?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime         @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, isRead, createdAt])
  @@index([memberId, createdAt])
  @@map("notifications")
}

enum NotificationType {
  TRANSFER_REQUEST
  TRANSFER_ACCEPTED
  TRANSFER_REJECTED
  TASK_OVERDUE
  ACHIEVEMENT_UNLOCKED
  LEVEL_UP
  REMINDER_DUE
  PLAN_READY
  PLAN_APPLIED
  REWARD_REDEEMED
}

// ============================================
// PUSH SUBSCRIPTION MODEL
// ============================================

model PushSubscription {
  id        String   @id @default(cuid())
  memberId  String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("push_subscriptions")
}

// ============================================
// WHATSAPP BOT MODEL
// ============================================

model WhatsAppLink {
  id                       String    @id @default(cuid())
  memberId                 String    @unique
  phoneNumber              String    @unique
  waId                     String?   @unique
  isActive                 Boolean   @default(true)
  verificationCode         String?
  verificationExpiresAt    DateTime?
  verificationAttempts     Int       @default(0)
  verifiedAt               DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([phoneNumber])
  @@map("whatsapp_links")
}

// ============================================
// RELAX SUGGESTIONS MODEL
// ============================================

model RelaxSuggestion {
  id          String   @id @default(cuid())
  householdId String
  locationKey String   // "lat_rounded:lng_rounded" e.g. "-34.6:-58.4"
  sectionType String   @default("culture") // "culture" | "restaurants" | "weekend"
  suggestions Json     // Array of RelaxEvent objects
  generatedAt DateTime @default(now())
  expiresAt   DateTime // generatedAt + 24h

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId, locationKey, sectionType, expiresAt])
  @@map("cultural_suggestions")
}

// ============================================
// GROCERY ADVISOR MODELS
// ============================================

enum GroceryCategory {
  ALMACEN
  PANADERIA_DULCES
  LACTEOS
  CARNES
  FRUTAS_VERDURAS
  BEBIDAS
  LIMPIEZA
  PERFUMERIA
}

model ProductCatalog {
  id           String          @id @default(cuid())
  name         String          @unique // "Leche entera"
  searchTerms  String          @default("") // Terms for web search queries: "leche entera sachet 1 litro"
  category     GroceryCategory
  isActive     Boolean         @default(true)
  isEssential  Boolean         @default(false) // Pre-selected in default shopping list
  createdAt    DateTime        @default(now())

  @@index([category, isActive])
  @@map("product_catalog")
}

model DealCache {
  id          String          @id @default(cuid())
  householdId String
  locationKey String          // "lat.toFixed(1):lng.toFixed(1)"
  category    GroceryCategory
  deals       Json            // StoreCluster[] serializado
  summary     String          // Recomendación: "Comprá en Carrefour..."
  generatedAt DateTime        @default(now())
  expiresAt   DateTime

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId, locationKey, category, expiresAt])
  @@map("deal_cache")
}

model HouseholdProductExclusion {
  id          String   @id @default(cuid())
  householdId String
  productName String
  createdAt   DateTime @default(now())

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([householdId, productName])
  @@index([householdId])
  @@map("household_product_exclusions")
}

model PriceCache {
  id          String   @id @default(cuid())
  householdId String
  locationKey String   // "lat.toFixed(1):lng.toFixed(1)"
  planData    Json     // ShoppingPlan completo
  generatedAt DateTime @default(now())
  expiresAt   DateTime

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId, locationKey, expiresAt])
  @@map("price_cache")
}

// ============================================
// CATALOG MODEL (Predefined Tasks)
// ============================================

model TaskCatalog {
  id               String        @id @default(cuid())
  name             String        @unique
  description      String?
  category         String
  defaultFrequency TaskFrequency @default(WEEKLY)
  defaultWeight    Int           @default(1)
  suggestedMinAge  Int?
  estimatedMinutes Int?

  @@map("task_catalog")
}

// ============================================
// EXPENSE MODELS
// ============================================

model Expense {
  id          String          @id @default(cuid())
  householdId String
  paidById    String
  title       String
  amount      Decimal         @db.Decimal(10, 2)
  currency    String          @default("ARS")
  category    ExpenseCategory @default(OTHER)
  date        DateTime        @default(now())
  notes       String?
  splitType   SplitType       @default(EQUAL)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  household Household    @relation(fields: [householdId], references: [id], onDelete: Cascade)
  paidBy    Member       @relation("ExpensesPaid", fields: [paidById], references: [id], onDelete: Cascade)
  splits    ExpenseSplit[]
  invoice   Invoice?

  @@index([householdId])
  @@index([paidById])
  @@index([householdId, date])
  @@map("expenses")
}

model ExpenseSplit {
  id        String    @id @default(cuid())
  expenseId String
  memberId  String
  amount    Decimal   @db.Decimal(10, 2)
  settled   Boolean   @default(false)
  settledAt DateTime?

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  member  Member  @relation("ExpenseSplits", fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([expenseId, memberId])
  @@index([memberId])
  @@index([memberId, settled])
  @@map("expense_splits")
}

enum ExpenseCategory {
  GROCERIES
  UTILITIES
  RENT
  FOOD
  TRANSPORT
  HEALTH
  ENTERTAINMENT
  EDUCATION
  HOME
  OTHER
}

enum SplitType {
  EQUAL
  CUSTOM
  PERCENTAGE
}

// ============================================
// SERVICE & INVOICE MODELS
// ============================================

model Service {
  id              String             @id @default(cuid())
  householdId     String
  title           String
  provider        String?            // "Edenor", "Telecom", etc.
  accountNumber   String?            // nro de cliente
  lastAmount      Decimal?           @db.Decimal(10, 2)
  currency        String             @default("ARS")
  category        ExpenseCategory    @default(OTHER)
  splitType       SplitType          @default(EQUAL)
  paidById        String
  notes           String?
  frequency       RecurringFrequency
  dayOfMonth      Int?               // 1-28 for MONTHLY+ frequencies
  dayOfWeek       Int?               // 0=Sunday..6=Saturday for WEEKLY
  autoGenerate    Boolean            @default(false)
  nextDueDate     DateTime
  lastGeneratedAt DateTime?
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  paidBy    Member    @relation("ServicesPaid", fields: [paidById], references: [id], onDelete: Cascade)
  invoices  Invoice[]

  @@index([householdId])
  @@index([householdId, isActive, nextDueDate])
  @@map("services")
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
}

model Invoice {
  id          String        @id @default(cuid())
  serviceId   String
  householdId String
  period      String        // "2026-02" (YYYY-MM)
  amount      Decimal       @db.Decimal(10, 2)
  dueDate     DateTime
  status      InvoiceStatus @default(PENDING)
  pdfUrl      String?       // Fase 1b
  expenseId   String?       @unique
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  expense   Expense?  @relation(fields: [expenseId], references: [id], onDelete: SetNull)

  @@unique([serviceId, period])
  @@index([serviceId])
  @@index([householdId, status])
  @@map("invoices")
}

enum RecurringFrequency {
  WEEKLY
  MONTHLY
  BIMONTHLY
  QUARTERLY
  YEARLY
}

// ============================================
// CULTURAL EVENTS MODELS
// ============================================

enum EventCategory {
  CINE
  TEATRO
  MUSICA
  EXPOSICIONES
  FESTIVALES
  MERCADOS
  PASEOS
  EXCURSIONES
  TALLERES
  DANZA
  LITERATURA
  GASTRONOMIA
  DEPORTES
  INFANTIL
  OTRO
}

enum EventStatus {
  ACTIVE
  CANCELLED
  PAST
}

enum EventSourceType {
  API
  SCRAPER
  WEB_DISCOVERY
  AGENDA
  VENUE
}

enum IngestionStatus {
  SUCCESS
  PARTIAL
  FAILED
}

model CulturalCity {
  id         String   @id @default(cuid())
  name       String
  province   String
  aliases    String[] @default([])
  latitude   Float?
  longitude  Float?
  population Int?
  createdAt  DateTime @default(now())

  events CulturalEvent[]
  venues CulturalVenue[]

  @@unique([name, province])
  @@map("cultural_cities")
}

model CulturalVenue {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  cityId    String?
  address   String?
  latitude  Float?
  longitude Float?
  website   String?
  phone     String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  city   CulturalCity?   @relation(fields: [cityId], references: [id], onDelete: SetNull)
  events CulturalEvent[]

  @@index([cityId])
  @@map("cultural_venues")
}

model EventSource {
  id               String          @id @default(cuid())
  type             EventSourceType
  name             String          @unique
  url              String?
  reliabilityScore Int             @default(50)
  isActive         Boolean         @default(true)
  lastFetchedAt    DateTime?
  lastSuccessAt    DateTime?
  errorCount       Int             @default(0)
  config           Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  events        CulturalEvent[]
  ingestionLogs EventIngestionLog[]

  @@index([type, isActive])
  @@map("event_sources")
}

model CulturalEvent {
  id            String        @id @default(cuid())
  title         String
  description   String?
  slug          String        @unique
  startDate     DateTime?
  endDate       DateTime?
  venueName     String?
  venueId       String?
  address       String?
  latitude      Float?
  longitude     Float?
  cityId        String?
  province      String?
  category      EventCategory @default(OTRO)
  tags          String[]      @default([])
  artists       String[]      @default([])
  priceMin      Float?
  priceMax      Float?
  currency      String?       @default("ARS")
  sourceId      String?
  sourceUrl     String?
  sourceEventId String?
  imageUrl      String?
  status        EventStatus   @default(ACTIVE)
  searchVector  Unsupported("tsvector")?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  venue  CulturalVenue? @relation(fields: [venueId], references: [id], onDelete: SetNull)
  city   CulturalCity?  @relation(fields: [cityId], references: [id], onDelete: SetNull)
  source EventSource?   @relation(fields: [sourceId], references: [id], onDelete: SetNull)

  @@index([cityId, category, startDate])
  @@index([startDate, status])
  @@index([sourceId, sourceEventId])
  @@index([status, startDate])
  @@map("cultural_events")
}

model EventIngestionLog {
  id              String          @id @default(cuid())
  sourceId        String
  status          IngestionStatus
  eventsFound     Int             @default(0)
  eventsCreated   Int             @default(0)
  eventsUpdated   Int             @default(0)
  eventsDuplicate Int             @default(0)
  errorMessage    String?
  durationMs      Int?
  createdAt       DateTime        @default(now())

  source EventSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId, createdAt])
  @@map("event_ingestion_logs")
}
